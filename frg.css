import requests
import json
import time
import openpyxl
from datetime import datetime
import os
import warnings
from requests.packages.urllib3.exceptions import InsecureRequestWarning

warnings.simplefilter('ignore', InsecureRequestWarning)

def read_from_excel(filename="wicreate.xlsx"):
    wb = openpyxl.load_workbook(filename)
    sheet = wb.active
    data = []
    headers = [cell.value for cell in sheet[1]]
    for row in sheet.iter_rows(min_row=2, values_only=True):
        row_data = dict(zip(headers, row))
        if row_data['resource_id']:  # Ensure the first cell (resource_id) is not empty
            data.append(row_data)
    return data

def get_auth_token():
    # ... (keep your existing get_auth_token function)

def create_workbench_instance(auth_token, row_data):
    url = "https://lumigcpauto-qa.aexp.com/un/v2/terraform/automate/workbench_instance"
    
    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    instance_name = f"wi-{row_data['req_ads_id']}-{timestamp}"
    
    payload = {
        "project_id": row_data['project_id'],
        "instance_name": instance_name,
        "env": "e2",
        "machine_type": "n2d-standard-4",
        "version": "0.0.8",
        "region": "us-central1",
        "source": "private/aexp/lumi-workbench-instance/google",
        "initialize_params": {
            "disk_size_gb": "150",
            "disk_type": "pd-ssd"
        },
        "vm_image": {
            "family": "workbench-instances",
            "project": "cloud-notebooks-managed"
        },
        "adsId": row_data['req_ads_id'],
        "runtime_owner": row_data['req_email_ad_tx'],
        "idle_shutdown_timeout": "120",
        "labels": {
            "team": "lumi",
            "ads-id": row_data['req_ads_id']
        },
        "metadata": {
            "disable-mixer": "True"
        }
    }
    
    headers = {
        'Authorization': f'Bearer {auth_token}',
        'Content-Type': 'application/json'
    }
    
    response = requests.request("POST", url, headers=headers, json=payload, verify=False)
    return json.loads(response.text)

def check_instance_status(auth_token, resource_name):
    # ... (keep your existing check_instance_status function)

def log_to_excel(resource_id, resource_name, status):
    filename = "workbench_instances_log.xlsx"
    
    if os.path.exists(filename):
        wb = openpyxl.load_workbook(filename)
        ws = wb.active
    else:
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.append(["Timestamp", "Resource ID", "Resource Name", "Status"])

    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    ws.append([timestamp, resource_id, resource_name, status])
    
    wb.save(filename)
    print(f"Logged resource ID {resource_id}, name {resource_name} with status {status} to {filename}")

def main():
    excel_data = read_from_excel()
    
    for row_data in excel_data:
        print(f"Processing resource ID: {row_data['resource_id']}")
        
        # Step 1: Get Auth Token
        auth_token = get_auth_token()
        print("Auth Token obtained successfully.")

        # Step 2: Create Workbench Instance
        create_response = create_workbench_instance(auth_token, row_data)
        resource_name = create_response.get('resourceName')
        if not resource_name:
            print("Failed to create workbench instance. Response:", create_response)
            log_to_excel(row_data['resource_id'], "N/A", "CREATION_FAILED")
            continue

        print(f"Workbench instance creation initiated. Resource Name: {resource_name}")

        # Step 3: Check Instance Status (poll every 30 seconds for 10 minutes)
        for _ in range(20):
            status_response = check_instance_status(auth_token, resource_name)
            status = status_response.get('status', 'UNKNOWN')
            print(f"Current status: {status}")
            
            # Log the current status to Excel
            log_to_excel(row_data['resource_id'], resource_name, status)
            
            if status == 'ACTIVE':
                print("Workbench instance is now active!")
                break
            elif status != 'PENDING':
                print(f"Unexpected status: {status}. Stopping the check.")
                break
            
            time.sleep(30)
        else:
            print("Timeout: Workbench instance did not become active within the expected time.")
            log_to_excel(row_data['resource_id'], resource_name, "TIMEOUT")

        print(f"Completed processing for resource ID: {row_data['resource_id']}\n")

if __name__ == "__main__":
    main()