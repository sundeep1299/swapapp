import requests
import json
from typing import Dict, Any
import os
from datetime import datetime
from dotenv import load_dotenv
import urllib3
import ssl
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.poolmanager import PoolManager

# Disable SSL verification warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class TLSAdapter(HTTPAdapter):
    def init_poolmanager(self, connections, maxsize, block=False):
        ctx = ssl.create_default_context()
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
        self.poolmanager = PoolManager(
            num_pools=connections,
            maxsize=maxsize,
            block=block,
            ssl_version=ssl.PROTOCOL_TLSv1_2,
            ssl_context=ctx
        )

class APIClient:
    def __init__(self, config: Dict[str, str]):
        self.host = config['host']
        self.app_id = config['app_id']
        self.secret = config['secret']
        self.version = config['version']
        
        # Create session with custom SSL adapter
        self.session = requests.Session()
        self.session.mount('https://', TLSAdapter())
        
    def get_idaas_jwt(self) -> Dict[str, Any]:
        """
        Method to get IDAAS JWT token for Gemini
        """
        url = f"{self.host}/security/digital/v1/application"
        
        payload = {
            "scope": [
                "/genai/google/v1/models/gemini-1.5-pro-002/**:post"
            ]
        }
        
        headers = {
            'Content-Type': 'application/json',
            'X-Auth-AppID': self.app_id,
            'X-Auth-Signature': self.secret,
            'X-Auth-Version': self.version,
            'X-Auth-Timestamp': str(int(datetime.now().timestamp())),
            'Accept': 'application/json'
        }
        
        try:
            print(f"\nMaking request to: {url}")
            print("Headers:", json.dumps(headers, indent=2))
            response = self.session.post(url, headers=headers, json=payload, verify=False)
            print(f"Response Status Code: {response.status_code}")
            if response.status_code != 200:
                print(f"Response content: {response.text}")
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error getting JWT token: {e}")
            print(f"Response content: {response.text if 'response' in locals() else 'No response'}")
            return None

    def call_genai_llm(self, auth_token: str, user_prompt: str) -> Dict[str, Any]:
        """
        Method to call GenAI LLM API with user provided prompt
        """
        url = "https://eap-dev.aexp.com/genai/google/v1/models/gemini-1.5-pro-002/generateContent"
        
        payload = {
            "contents": [
                {
                    "parts": [
                        {
                            "text": user_prompt
                        }
                    ]
                },
                {
                    "role": "model"
                }
            ]
        }
        
        headers = {
            'Authorization': f'Bearer {auth_token}',
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache'
        }
        
        try:
            response = self.session.post(url, headers=headers, json=payload, verify=False)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error calling Gemini API: {e}")
            if 'response' in locals():
                print(f"Response content: {response.text}")
            return None

def get_user_input() -> str:
    """
    Get the prompt from the user with input validation
    """
    while True:
        prompt = input("\nEnter your prompt for Gemini (or 'quit' to exit): ").strip()
        if prompt.lower() == 'quit':
            return None
        if prompt:
            return prompt
        print("Please enter a valid prompt!")

def main():
    # Load environment variables
    try:
        load_dotenv(override=True, encoding='utf-8')
    except Exception as e:
        print(f"Error loading .env file: {e}")
        print("Please make sure your .env file is saved with UTF-8 encoding")
        return

    # Check environment variables
    config = {
        'host': os.getenv('IDAAS_HOST'),
        'app_id': os.getenv('APP_ID'),
        'secret': os.getenv('SECRET'),
        'version': os.getenv('VERSION')
    }

    # Validate config
    missing_vars = [key for key, value in config.items() if not value]
    if missing_vars:
        print("\nError: Missing required environment variables:", missing_vars)
        return
        
    print("\nEnvironment Variables Status:")
    print("-" * 30)
    for key, value in config.items():
        status = "✓ Present" if value else "✗ Missing"
        print(f"{key}: {status}")
        if value:
            print(f"  Value: {value}")
    
    client = APIClient(config)
    
    print("\nWelcome to the Gemini API Interface!")
    print("-----------------------------------")
    
    while True:
        # Get user input
        user_prompt = get_user_input()
        if user_prompt is None:
            print("\nGoodbye!")
            break
            
        # Get JWT token
        print("\nGetting authentication token...")
        jwt_response = client.get_idaas_jwt()
        
        if not jwt_response or 'auth_token' not in jwt_response:
            print("Failed to get authentication token. Please try again.")
            continue
            
        auth_token = jwt_response['auth_token']
        
        # Call Gemini API
        print("Sending prompt to Gemini...")
        llm_response = client.call_genai_llm(auth_token, user_prompt)
        
        if llm_response:
            print("\nGemini Response:")
            print("-----------------")
            print(json.dumps(llm_response, indent=2))
        else:
            print("Failed to get response from Gemini. Please try again.")
        
        print("\n" + "="*50 + "\n")

if __name__ == "__main__":
    main()